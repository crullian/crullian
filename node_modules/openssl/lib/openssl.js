var spawn   = require("child_process").spawn;
var openssl = module.exports = {};

openssl.genrsa = function genrsa(key, options) {
  var args = ["genrsa", "-out", key, 1024];
  return spawn("openssl", args, options);
};

openssl.req = function req(csr, key, config, options) {
  var args = [
    'req', '-new',
    "-out", csr,
    "-key", key,
    "-config", config
  ];
  return spawn("openssl", args, options);
};

openssl.x509 = function x509(crt, csr, key, ca, options) {

  // base args
  var args = [
    "x509", "-req",
    "-out", crt,
    "-in", csr
  ];

  // ca-signed
  if (ca) {
    args.push(
      "-CA",            ca.crt,
      "-CAkey",         ca.key,
      "-CAserial",      ca.srl,
      "-CAcreateserial"
    );
  }

  // self-signed
  else if (key) {
    args.push("-signkey", key);
  }

  return spawn("openssl", args, options);
};

openssl.pkcs12 = function pkcs12(pfx, crt, key, ca, options) {
  var args = [
    "pkcs12",     "-export",
    "-out",       pfx,
    "-in",        crt,
    "-inkey",     key,
    "-certfile",  ca.crt,
    "-passout",   "pass:"
  ];

  return spawn("openssl", args, options);
};
